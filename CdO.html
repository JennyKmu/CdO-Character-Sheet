<!-- <div class="sheet-preload">
    <img class="sheet-hide" src="https://jen.shx.gg/5Y0P93IVN.png" alt="BG">
</div> -->

<input type="hidden" name="attr_level" value="1">

<input type="hidden" name="attr_hp" value="10">
<input type="hidden" name="attr_hp_max" value="10">
<input type="hidden" name="attr_level" value="1">
<input type="hidden" name="attr_hp_n_dice" value="1">
<input type="hidden" name="attr_hp_lvl_dice" value="3">
<input type="hidden" name="attr_hp_val_dice" value="8">
<input type="hidden" name="attr_hp_static" value="5">

<input type="hidden" name="attr_hd" value="4">
<input type="hidden" name="attr_hd_max" value="4">
<input type="hidden" name="attr_hd_lvl_dice" value="2">
<input type="hidden" name="attr_hd_val_dice" value="6">

<input type="hidden" name="attr_std" value="1">
<input type="hidden" name="attr_adm" value="7">
<input type="hidden" name="attr_def" value="0">
<input type="hidden" name="attr_std_mod" value="0">
<input type="hidden" name="attr_adm_mod" value="0">
<input type="hidden" name="attr_def_mod" value="0">
<input type="hidden" name="attr_armor_mod" value="0">
<input type="hidden" name="attr_depl" value="0">
<input type="hidden" name="attr_shield" values="0">

<!-- <div class="gobal-div"> -->

<!-- <div class="bg-div"> -->
  <!-- <img class="white-background-img" src="https://jen.shx.gg/5YxQK6Us6.png" alt="BG" draggable="false" unselectable="on"> -->
  <!-- <img class="white-background-img" style="top:820px;" src="https://jen.shx.gg/5YxQK6Us6.png" alt="BG" draggable="false" unselectable="on"> -->
<!-- </div> -->
<div class="main-div">
  <img class="white-background-img" src="https://jen.shx.gg/5YxQK6Us6.png" alt="WhiteBG" draggable="false" unselectable="on">
  <img class="background-img" src="https://jen.shx.gg/5Yowo3NJC.png" alt="BG" draggable="false" unselectable="on">

  <div class="toplayer">
    <!-- Nom du personnage -->
    <div class="name">
      <input class="text" name="attr_character_name" type="text" spellcheck="false">
    </div>

    <!-- Aspects -->
    <div class="aspect" style="top:205px">
      <div style="position: absolute;">
          <input name="attr_aspect_1" type="text" placeholder="-" spellcheck="false">
      </div>
      <div style="position: absolute; top:35px">
          <input name="attr_aspect_2" type="text" placeholder="-" spellcheck="false">
      </div>
      <div style="position: absolute; top:70px">
          <input name="attr_aspect_3" type="text" placeholder="-" spellcheck="false">
      </div>
    </div>

    <!-- Dons & Sorts -->
    <div class="skill" style="top: 335px">
      <div>
          <select class="select" name="attr_skill_1">
              <option value="0">-</option>
              <option value="101">Armes de prédilection (Contact)</option>
              <option value="201">Armes de prédilection (Distance)</option>
              <option value="2">Artefact légendaire</option>
              <option value="3">Attaque sournoise</option>
              <option value="4">Chance</option>
              <option value="5">Combat à deux armes</option>
              <option value="6">Commandemnt</option>
              <option value="7">Enchaînement</option>
              <option value="8">Esquive acrobatique</option>
              <option value="9">Magie du cercle premier</option>
              <option value="10">Magie du cercle second</option>
              <option value="11">Maîtrise des armures</option>
              <option value="12">Maîtrise des boucliers</option>
              <option value="13">Science de l'initiative</option>
              <option value="14">Talents variés</option>
              <option value="15">Vigueur</option>
              <option value="16">Vision nocturne</option>
              <option value="17">Tir rapide</option>
          </select>
      </div>

      <div style="top:35px;">
          <select class="select" name="attr_skill_2">
              <option value="0">-</option>
              <option value="101">Armes de prédilection (Contact)</option>
              <option value="201">Armes de prédilection (Distance)</option>
              <option value="2">Artefact légendaire</option>
              <option value="3">Attaque sournoise</option>
              <option value="4">Chance</option>
              <option value="5">Combat à deux armes</option>
              <option value="6">Commandemnt</option>
              <option value="7">Enchaînement</option>
              <option value="8">Esquive acrobatique</option>
              <option value="9">Magie du cercle premier</option>
              <option value="10">Magie du cercle second</option>
              <option value="11">Maîtrise des armures</option>
              <option value="12">Maîtrise des boucliers</option>
              <option value="13">Science de l'initiative</option>
              <option value="14">Talents variés</option>
              <option value="15">Vigueur</option>
              <option value="16">Vision nocturne</option>
              <option value="17">Tir rapide</option>
          </select>
      </div>

      
      <div style="top:70px;">
          <select class="select" name="attr_skill_3">
              <option value="0">-</option>
              <option value="101">Armes de prédilection (Contact)</option>
              <option value="201">Armes de prédilection (Distance)</option>
              <option value="2">Artefact légendaire</option>
              <option value="3">Attaque sournoise</option>
              <option value="4">Chance</option>
              <option value="5">Combat à deux armes</option>
              <option value="6">Commandemnt</option>
              <option value="7">Enchaînement</option>
              <option value="8">Esquive acrobatique</option>
              <option value="9">Magie du cercle premier</option>
              <option value="10">Magie du cercle second</option>
              <option value="11">Maîtrise des armures</option>
              <option value="12">Maîtrise des boucliers</option>
              <option value="13">Science de l'initiative</option>
              <option value="14">Talents variés</option>
              <option value="15">Vigueur</option>
              <option value="16">Vision nocturne</option>
              <option value="17">Tir rapide</option>
          </select>
      </div>

      
      <div style="top:105px;">
          <select class="select" name="attr_skill_4">
              <option value="0">-</option>
              <option value="101">Armes de prédilection (Contact)</option>
              <option value="201">Armes de prédilection (Distance)</option>
              <option value="2">Artefact légendaire</option>
              <option value="3">Attaque sournoise</option>
              <option value="4">Chance</option>
              <option value="5">Combat à deux armes</option>
              <option value="6">Commandemnt</option>
              <option value="7">Enchaînement</option>
              <option value="8">Esquive acrobatique</option>
              <option value="9">Magie du cercle premier</option>
              <option value="10">Magie du cercle second</option>
              <option value="11">Maîtrise des armures</option>
              <option value="12">Maîtrise des boucliers</option>
              <option value="13">Science de l'initiative</option>
              <option value="14">Talents variés</option>
              <option value="15">Vigueur</option>
              <option value="16">Vision nocturne</option>
              <option value="17">Tir rapide</option>
          </select>
      </div>

      
      <div style="top:140px;">
          <select class="select" name="attr_skill_5">
              <option value="0">-</option>
              <option value="101">Armes de prédilection (Contact)</option>
              <option value="201">Armes de prédilection (Distance)</option>
              <option value="2">Artefact légendaire</option>
              <option value="3">Attaque sournoise</option>
              <option value="4">Chance</option>
              <option value="5">Combat à deux armes</option>
              <option value="6">Commandemnt</option>
              <option value="7">Enchaînement</option>
              <option value="8">Esquive acrobatique</option>
              <option value="9">Magie du cercle premier</option>
              <option value="10">Magie du cercle second</option>
              <option value="11">Maîtrise des armures</option>
              <option value="12">Maîtrise des boucliers</option>
              <option value="13">Science de l'initiative</option>
              <option value="14">Talents variés</option>
              <option value="15">Vigueur</option>
              <option value="16">Vision nocturne</option>
              <option value="17">Tir rapide</option>
          </select>
      </div>

      <div style="top:175px;">
        <select class="select" name="attr_skill_6">
            <option value="0">-</option>
            <option value="101">Armes de prédilection (Contact)</option>
            <option value="201">Armes de prédilection (Distance)</option>
            <option value="2">Artefact légendaire</option>
            <option value="3">Attaque sournoise</option>
            <option value="4">Chance</option>
            <option value="5">Combat à deux armes</option>
            <option value="6">Commandemnt</option>
            <option value="7">Enchaînement</option>
            <option value="8">Esquive acrobatique</option>
            <option value="9">Magie du cercle premier</option>
            <option value="10">Magie du cercle second</option>
            <option value="11">Maîtrise des armures</option>
            <option value="12">Maîtrise des boucliers</option>
            <option value="13">Science de l'initiative</option>
            <option value="14">Talents variés</option>
            <option value="15">Vigueur</option>
            <option value="16">Vision nocturne</option>
            <option value="17">Tir rapide</option>
        </select>
      </div>

      <div style="top:210px;">
        <div style="position:absolute; left:-100px;">Langues : </div>
        <div class="langues-input" style="position:absolute;"><input name="attr_languages" type="text" spellcheck="false"></div>
      </div>
  
    </div>


    <!-- Equipement -->
    <div class="gear" style="top:610px">
      
      <div style="top:140px;">
          <input type="checkbox" name="attr_shield"> Bouclier
      </div>

      <div>
          <select class="select"  name="attr_armor">
              <option value="0">Pas d'Armure</option>
              <option value="2">Armure Légère</option>
              <option value="4">Armure Mixte</option>
              <option value="6">Armure Lourde</option>
          </select>
          <div style="left:305px">
            +<span name="attr_armor"></span>
          </div>
      </div>

      <div style="top:35px;">
          <select class="select" name="attr_weapon_1">
            <option value="-">-</option>
            <option value="Arme Légère / de Jet">Arme Légère / de Jet</option>
            <option value="Arme à une main">Arme à une main</option>
            <option value="Arme à deux main">Arme à deux main</option>
            <option value="Arme à distance">Arme à distance</option>
            <option value="Dague">Dague</option>
            <option value="Couteau">Couteau</option>
            <option value="Baton">Baton</option>
            <option value="Epée">Epée</option>
            <option value="Fauchon">Fauchon</option>
            <option value="Masse d'armes">Masse d'armes</option>
            <option value="Marteau d'armes">Marteau d'armes</option>
            <option value="Fléau d'armes">Fléau d'armes</option>
            <option value="Cimeterre">Cimeterre</option>
            <option value="Bardiche">Bardiche</option>
            <option value="Hallebarde">Hallebarde</option>
            <option value="Espadon">Espadon</option>
            <option value="Nodachi">Nodachi</option>
            <option value="Ram-Dao">Ram-Dao</option>
            <option value="Hache d'armes">Hache d'armes</option>
            <option value="Arc et carquois">Arc et carquois</option>
            <option value="Fronde">Fronde</option>
            <option value="Pistolet à poudre">Pistolet à poudre</option>
            <option value="Arbalète de poing">Arbalète de poing</option>
            <option value="Fusil à poudre">Fusil à poudre</option>
            <option value="Arbalète">Arbalète</option>
          </select>
          <input type="hidden" name="attr_weapon_1_cac_text" value="">
          <input type="hidden" name="attr_weapon_1_dis_text" value="">
          <input type="hidden" name="attr_weapon_1_cac_roll" value="">
          <input type="hidden" name="attr_weapon_1_dis_roll" value="">
          
          <input type="checkbox" style="visibility: hidden;" class="weapon-cac-switch" name="attr_weapon_1_cac_switch" value="0" />
          <button class="weapon_button cac" id="button_weapon_1_cac_roll" type="roll"
          value="&{template:rolls} {{text=@{character_name} fait [[@{weapon_1_cac_roll}]] dégâts au contact!}}" name="roll_weapon_1_cac">
          <span name="attr_weapon_1_cac_text"></span></button>
          <input type="checkbox" style="visibility: hidden;" class="weapon-dis-switch" name="attr_weapon_1_dis_switch" value="0" />
          <button class="weapon_button dis" id="button_weapon_1_dis_roll" type="roll"
          value="&{template:rolls} {{text=@{character_name} fait [[@{weapon_1_dis_roll}]] dégâts à distance!}}" name="roll_weapon_1_dis">
          <span name="attr_weapon_1_dis_text"></span></button>
      </div>

      <div style="top:70px;">
          <select class="select" name="attr_weapon_2">
            <option value="-">-</option>
            <option value="Arme Légère / de Jet">Arme Légère / de Jet</option>
            <option value="Arme à une main">Arme à une main</option>
            <option value="Arme à deux main">Arme à deux main</option>
            <option value="Arme à distance">Arme à distance</option>
            <option value="Dague">Dague</option>
            <option value="Couteau">Couteau</option>
            <option value="Baton">Baton</option>
            <option value="Epée">Epée</option>
            <option value="Fauchon">Fauchon</option>
            <option value="Masse d'armes">Masse d'armes</option>
            <option value="Marteau d'armes">Marteau d'armes</option>
            <option value="Fléau d'armes">Fléau d'armes</option>
            <option value="Cimeterre">Cimeterre</option>
            <option value="Bardiche">Bardiche</option>
            <option value="Hallebarde">Hallebarde</option>
            <option value="Espadon">Espadon</option>
            <option value="Nodachi">Nodachi</option>
            <option value="Ram-Dao">Ram-Dao</option>
            <option value="Hache d'armes">Hache d'armes</option>
            <option value="Arc et carquois">Arc et carquois</option>
            <option value="Fronde">Fronde</option>
            <option value="Pistolet à poudre">Pistolet à poudre</option>
            <option value="Arbalète de poing">Arbalète de poing</option>
            <option value="Fusil à poudre">Fusil à poudre</option>
            <option value="Arbalète">Arbalète</option>
          </select>
          <input type="hidden" name="attr_weapon_2_cac_text" value="">
          <input type="hidden" name="attr_weapon_2_dis_text" value="">
          <input type="hidden" name="attr_weapon_2_cac_roll" value="">
          <input type="hidden" name="attr_weapon_2_dis_roll" value="">

          <input type="checkbox" style="visibility: hidden;" class="weapon-cac-switch" name="attr_weapon_2_cac_switch" value="0" />
          <button class="weapon_button cac" id="button_weapon_2_cac_roll" type="roll"
          value="&{template:rolls} {{text=@{character_name} fait [[@{weapon_2_cac_roll}]] dégâts au contact!}}" name="roll_weapon_2_cac">
          <span name="attr_weapon_2_cac_text"></span></button>
          <input type="checkbox" style="visibility: hidden;" class="weapon-dis-switch" name="attr_weapon_2_dis_switch" value="0" />
          <button class="weapon_button dis" id="button_weapon_2_dis_roll" type="roll"
          value="&{template:rolls} {{text=@{character_name} fait [[@{weapon_2_dis_roll}]] dégâts à distance!}}" name="roll_weapon_2_dis">
          <span name="attr_weapon_2_dis_text"></span></button>
      </div>

      <div style="top:105px;">
          <select class="select" name="attr_weapon_3">
            <option value="-">-</option>
            <option value="Arme Légère / de Jet">Arme Légère / de Jet</option>
            <option value="Arme à une main">Arme à une main</option>
            <option value="Arme à deux main">Arme à deux main</option>
            <option value="Arme à distance">Arme à distance</option>
            <option value="Dague">Dague</option>
            <option value="Couteau">Couteau</option>
            <option value="Baton">Baton</option>
            <option value="Epée">Epée</option>
            <option value="Fauchon">Fauchon</option>
            <option value="Masse d'armes">Masse d'armes</option>
            <option value="Marteau d'armes">Marteau d'armes</option>
            <option value="Fléau d'armes">Fléau d'armes</option>
            <option value="Cimeterre">Cimeterre</option>
            <option value="Bardiche">Bardiche</option>
            <option value="Hallebarde">Hallebarde</option>
            <option value="Espadon">Espadon</option>
            <option value="Nodachi">Nodachi</option>
            <option value="Ram-Dao">Ram-Dao</option>
            <option value="Hache d'armes">Hache d'armes</option>
            <option value="Arc et carquois">Arc et carquois</option>
            <option value="Fronde">Fronde</option>
            <option value="Pistolet à poudre">Pistolet à poudre</option>
            <option value="Arbalète de poing">Arbalète de poing</option>
            <option value="Fusil à poudre">Fusil à poudre</option>
            <option value="Arbalète">Arbalète</option>
          </select>
          <input type="hidden" name="attr_weapon_3_cac_text" value="">
          <input type="hidden" name="attr_weapon_3_dis_text" value="">
          <input type="hidden" name="attr_weapon_3_cac_roll" value="">
          <input type="hidden" name="attr_weapon_3_dis_roll" value="">

          <input type="checkbox" style="visibility: hidden;" class="weapon-cac-switch" name="attr_weapon_3_cac_switch" value="0" />
          <button class="weapon_button cac" id="button_weapon_3_cac_roll" type="roll"
          value="&{template:rolls} {{text=@{character_name} fait [[@{weapon_3_cac_roll}]] dégâts au contact!}}" name="roll_weapon_3_cac">
          <span name="attr_weapon_3_cac_text"></span></button>
          <input type="checkbox" style="visibility: hidden;" class="weapon-dis-switch" name="attr_weapon_3_dis_switch" value="0" />
          <button class="weapon_button dis" id="button_weapon_3_dis_roll" type="roll"
          value="&{template:rolls} {{text=@{character_name} fait [[@{weapon_3_dis_roll}]] dégâts à distance!}}" name="roll_weapon_3_dis">
          <span name="attr_weapon_3_dis_text"></span></button>
      </div>

      
    </div>    
    

    <!-- Bonus aux jets -->
    <div class="bonus">
      <div class="standard">
        <button class="bonus_button" id="button_bonus_std" type="roll"
        value="&{template:rolls} {{text=@{character_name} fait [[d20+@{std}]] sur un jet standard!}}" name="roll_std">
          <span name="attr_std"></span>  
          <!-- <input class="score score-input" name="attr_std_display" value="(@{std})" type="text" disabled="true" spellcheck="false" /> -->
        </button>
      </div>
      <div class="movement">
        <button class="bonus_button" id="button_bonus_adm" type="roll"
        value="&{template:rolls} {{text=@{character_name} fait [[d20+@{adm}]] sur un jet d'arts du mouvement!}}" name="roll_adm">
          <span name="attr_adm"></span>
          <!-- <input class="score score-input" name="attr_adm_display" value="(@{adm})" type="text" disabled="true" spellcheck="false" /> -->
        </button>
      </div>
      <div class="defense">
        <button class="bonus_button" id="button_bonus_def" type="roll"
        value="&{template:rolls} {{text=@{character_name} fait [[d20+@{def}]] sur un jet de défense!}}" name="roll_def">
          <span name="attr_def"></span>
          <!-- <input class="score score-input" name="attr_def_display" value="(@{def})" type="text" disabled="true" spellcheck="false" /> -->
        </button>
      </div>
    </div>

    <!-- Niveau -->
    <div class="level">
      <button class="bonus_button" id="button_level" type="button">
        <span name="attr_level"></span>
        <!-- <input class="score score-input" name="attr_level_display" value="(@{level})" type="text" disabled="true" spellcheck="false" /> -->
      </button>
      <button class="selector increase" type="action" name="act_increase_level">▲</button>
      <button class="selector decrease" type="action" name="act_decrease_level">▼</button>
    </div>

    <!-- Dés de vie -->
    <div class="hpdice">
      <button class="bonus_button" id="button_hpdice" type="action" name="act_hp_dice">
        <span name="attr_hp_n_dice"></span>D<span name="attr_hp_val_dice"></span><br/>
        +<span name="attr_hp_static"></span>
      </button>
    </div>

    <div class="hpcount">
      <button class="bonus_button" id="button_hpcount" type="button">
        <span name="attr_hp"></span>/<span name="attr_hp_max"></span>
      </button>
      <button class="selector increase" type="action" name="act_increase_hp">⯈</button>
      <button class="selector decrease" type="action" name="act_decrease_hp">⯇</button>
    </div>

    
    <div class="hddice">
      <button class="bonus_button" id="button_hddice" type="action" name="act_hd_dice">
        <span name="attr_hd"></span>/<span name="attr_hd_max"></span><br/>
        (D<span name="attr_hd_val_dice"></span>)
      </button>
      <button class="selector" id="button_repos" type="action" name="act_repos">
        Repos
      </button>
    </div>


  </div>
</div>
<div class="note-div">
  <span>Notes :</span>
  <textarea name="attr_notes" ></textarea>
</div>

<!-- </div> -->
<!-- <input type="hidden" name="attr_armor" value="0"> -->

<div class="lock gearlock">
  <button class="lock-button" id="button_gearlock" type="action" name="act_gearlock">
    <input type="checkbox" name="attr_gearlock" value="0" style="display:none;"/><span class="material-icons lock-symbol">lock </span><span class="material-icons unlock-symbol">lock_open</span>
  </button>
</div>



<script type="text/worker">

const locks = ["gearlock"];

locks.forEach(lock => {
  on(`clicked:${lock}`, () => {
    getAttrs([lock], (values) => {
      console.log(lock, " : ", values[lock]);
      setAttrs({
        [`${lock}`]: (values[lock] == "on") ? 0 : "on"
      });
    });
  });
});

const v_skills = ["skill_1", "skill_2", "skill_3", "skill_4", "skill_5", "skill_6"];
const c_skills = "change:skill_1 change:skill_2 change:skill_3 change:skill_4 change:skill_5 change:skill_6";
const v_weapons = ["weapon_1", "weapon_2", "weapon_3"];

const weapons_damage = {
  "-": "0/0",
  "Arme Légère / de Jet": "D4/D4",
  "Arme à une main": "D8/0",
  "Arme à deux main": "D10/0",
  "Arme à distance": "0/D6",
  "Dague": "D4/D4",
  "Couteau": "D4/D4",
  "Baton": "D6/0",
  "Epée": "D8/0",
  "Fauchon": "D8/0",
  "Masse d'armes": "D8/0",
  "Marteau d'armes": "D8/0",
  "Fléau d'armes": "D8/0",
  "Cimeterre": "D8/0",
  "Bardiche": "D8/0",
  "Hallebarde": "D10/0",
  "Espadon": "D10/0",
  "Nodachi": "D10/0",
  "Ram-Dao": "D10/0",
  "Hache d'armes": "D10/0",
  "Arc et carquois": "0/D6",
  "Fronde": "0/D6",
  "Pistolet à poudre": "0/D6+1",
  "Arbalète de poing": "0/D6+1",
  "Fusil à poudre": "0/D6+2",
  "Arbalète": "0/D6+2"
};



const f_lvl2val = (lvl)=>{
  if (lvl == 6) { return 20; }
  return 2+2*lvl;
}

const f_val2lvl = (val)=>{
  if (val == 20) { return 6; }
  return (val-2)/2;
}

const f_look_for_skill = (values, number)=>{
  return (f_count_skill(values, number) > 0);
}

const f_count_skill = (values, number)=>{
  let ans = 0;
  for (let i = 1; i <= 6; i++ ) {
    let sk = parseInt(values[`skill_${i}`]);
    if (sk == number) { ans++; }
  }
  console.log(`Skillcount for ${number}: ${ans}`)
  return ans;
}


const f_update_def_mod = ()=>{
  vtab = [];
  vtab = vtab.concat(["shield", "armor"]);
  vtab = vtab.concat(v_skills);
  getAttrs(vtab, function(values) {
    let in_shield = values.shield;
    console.log("--- f_update_def_mod | values.shield : ", values.shield);
    let new_armor_mod = 0;
    if (in_shield == "on") {
      new_armor_mod = 1;
    }
    console.log("New armor_mod: ", new_armor_mod);

    let new_def_mod = 0;
    if (f_look_for_skill(values, 8) > 0) {
      let in_armor = parseInt(values.armor)||0;
      in_armor += new_armor_mod;
      if (in_armor <= 3) {
        new_def_mod = 2
      }
    }
    console.log("New def_mod: ", new_def_mod);


    setAttrs({
      armor_mod: new_armor_mod,
      def_mod: new_def_mod
    });
  });
}

const f_update_adm_mod = ()=>{
  vtab = [];
  vtab = vtab.concat(["armor"]);
  vtab = vtab.concat(v_skills);
  console.log(vtab.toString());
  getAttrs(vtab, function(values) {
    console.log(values)
    let res = 0;
    if (f_look_for_skill(values, 11) > 0) {
      let _armor = parseInt(values.armor)||0;
      if (_armor >= 4) { res += 2; }
    }
    //res = Math.min(2, Math.max(0, _armor-4)); // Custom interpretation

    console.log("New ADM modifier is: ", res);
    setAttrs({ adm_mod: res });
  });
}

const f_update_depl = ()=>{
  vtab = [];
  vtab = vtab.concat(["shield", "armor"]);
  getAttrs(vtab, function(values) {
    let res = 0;
    let _armor = parseInt(values.armor)||0;
    let _shield = (values.shield == "on") ? 1 : 0;
    console.log(_armor, _shield);
    if (_armor <= 2) { res = 8-_armor; }
    if (_armor >= 4) { res = 10-_armor; }
    if (_armor == 3) { res = 6; }
    res -= _shield;
    console.log("New depl is: ", res);
    setAttrs({ depl: res });
  });
}

const f_update_life_hd = ()=>{
  vtab = [];
  vtab = vtab.concat(v_skills);
  getAttrs(vtab, function(values) {
    let _level = parseInt(values.level)||0;
    let new_hp_lvl = 3;
    if (f_look_for_skill(values, 15) > 0) { new_hp_lvl += 1; } // "Vigueur"
    if (f_look_for_skill(values, 9)  > 0) { new_hp_lvl -= 1; } // "Magie du cercle premier"
    if (f_look_for_skill(values, 10) > 0) { new_hp_lvl -= 1; } // "Magie du cercle second"
    let new_hp_val = f_lvl2val(new_hp_lvl);


    let new_hd_lvl = 2;
    if (f_look_for_skill(values, 4) > 0) { new_hd_lvl += 1; }
    let new_hd_val = f_lvl2val(new_hd_lvl);

    console.log("HP dice is a D", new_hp_val, " (dice level ", new_hp_lvl, ")");
    console.log("HD dice is a D", new_hd_val, " (dice level ", new_hd_lvl, ")");
    setAttrs({ 
      hp_lvl_dice: new_hp_lvl,
      hp_val_dice: new_hp_val,
      hd_lvl_dice: new_hd_lvl,
      hd_val_dice: new_hd_val
    });
  });
}

/*
const f_update_weapons = ()=>{
  vtab = [];
  vtab = vtab.concat(v_skills);
  vtab = vtab.concat(v_weapons);
  
  getAttrs(vtab, function(values) {
    let wp1name = values.weapon_1||"-";
    let wp1 = weapons_damage[wp1name]

    let wp1split = wp1.split('|');
    let wp1cac = wp1split[0];
    let wp1dis = wp1split[1];

    setAttrs({
    });
  });
}
*/

v_weapons.forEach(wp => {
  on(`change:${wp} ${c_skills}`, function() {
    vtab = [wp];
    vtab = vtab.concat(v_skills);
    vtab = vtab.concat([`${wp}_cac_switch`, `${wp}_dis_switch`]);
    console.log(`Variables for ${wp}: ${vtab}`);
    getAttrs(vtab, values => {
      const w_name = values[wp]||"-";
      const w_stat = weapons_damage[w_name]||"0/0";
      const mods_id = [101, 201];
      console.log("Updating ", wp, " damage to ", w_stat);
      let ws = w_stat.split("/");
      ws.forEach((w,i) => {
        if (w.includes("D")) {
          d_val = parseInt(w.match("D\\d+")[0].match("\\d+")[0]);
          d_new = f_lvl2val(Math.min(5,f_val2lvl(d_val)+Math.min(1,f_count_skill(values, mods_id[i]))));
          ws[i] = w.replace(`D${d_val}`, `D${d_new}`);
        }
      });

      let w_cac_text = ws[0];
      let w_dis_text = ws[1];
      let w_cac_roll = w_cac_text.toLowerCase();
      let w_dis_roll = w_dis_text.toLowerCase();

      let show_cac = (w_cac_text == "0") ? "checked" : "0";
      w_cac_text = (w_cac_text == "0") ? "" : w_cac_text;
      
      let show_dis = (w_dis_text == "0") ? "checked" : "0";
      w_dis_text = (w_dis_text == "0") ? "" : w_dis_text;

      setAttrs({
        [`${wp}_cac_text`]: w_cac_text,
        [`${wp}_dis_text`]: w_dis_text,
        [`${wp}_cac_roll`]: w_cac_roll,
        [`${wp}_dis_roll`]: w_dis_roll,
        [`${wp}_cac_switch`]: show_cac,
        [`${wp}_dis_switch`]: show_dis
      });
    });
  });
});

on("sheet:opened change:level change:armor change:shield change:weapon_1 change:weapon_2 change:weapon_3 change:skill_1 change:skill_2 change:skill_3 change:skill_4 change:skill_5", function() {
    
  });

on("sheet:opened change:shield change:armor", f_update_depl);

on("sheet:opened " + c_skills, f_update_life_hd);

on("sheet:opened change:armor " + c_skills, f_update_adm_mod);


on("sheet:opened change:shield " + c_skills , f_update_def_mod);

on("sheet:opened change:level", () => {
  getAttrs(["level"], (values) => {
    const lvl=parseInt(values.level)||0;
    setAttrs({
      hp_static: lvl+4,
      hd_max: lvl+3,
      hp_n_dice: lvl
    });
  });
});

on("sheet:opened change:level change:std_mod", () => {
  getAttrs(["level", "std_mod"], (values) => {
    const lvl = parseInt(values.level)||0;
    const mod = parseInt(values.std_mod)||0;
    setAttrs({ std: lvl+mod });
  });
}); 


on("sheet:opened change:level change:armor change:armor_mod change:adm_mod", () => {
  getAttrs(["level", "armor", "armor_mod", "adm_mod"], (values) => {
    const lvl = parseInt(values.level)||0;
    const def = (parseInt(values.armor)||0) + (parseInt(values.armor_mod)||0);
    const mod = parseInt(values.adm_mod)||0;
    setAttrs({ adm: lvl-def+mod+6 });
  });
});


on("sheet:opened change:armor change:armor_mod change:def_mod", () => {
  getAttrs(["armor", "armor_mod", "def_mod"], (values) => {
    const ndef = (parseInt(values.armor)||0) + (parseInt(values.armor_mod)||0);
    const mod = parseInt(values.def_mod)||0;
    setAttrs({ def: ndef+mod });
  });
});


on('clicked:increase_level', () => {
  getAttrs(['level'], (values) => {
    const lvl = parseInt(values.level)|0;
    setAttrs({
      level: Math.min(6,lvl+1)
    });
  });
});

on('clicked:decrease_level', () => {
  getAttrs(['level'], (values) => {
    const lvl = parseInt(values.level)||0;
    setAttrs({
      level: Math.max(1,lvl-1)
    });
  });
});

on('clicked:increase_hp', () => {
  getAttrs(['hp', 'hp_max'], (values) => {
    const chp = parseInt(values.hp)|0;
    const mhp = parseInt(values.hp_max)|0;
    setAttrs({
      hp: Math.min(mhp, chp+1)
    });
  });
});

on('clicked:decrease_hp', () => {
  getAttrs(['hp'], (values) => {
    const chp = parseInt(values.hp)||0;
    setAttrs({
      hp: Math.max(0,chp-1)
    });
  });
});

on('clicked:hp_dice', () => {
  console.log("hp_dice");
  startRoll("&{template:rolls} {{title=Dés de Vie}} {{text=@{character_name} obtient [[@{hp_n_dice}d@{hp_val_dice} + @{hp_static}]] points de vie.}}", (results) => {
    const res = results.results.text.result;
    finishRoll(results.rollId);
    setAttrs({
      hp_max: res,
      hp:     res
    });
  });
});

on('clicked:hd_dice', () => {
  console.log("hd_dice");
  getAttrs(["hd"], (values) => {
    const nhd = parseInt(values.hd)||0;
    if (nhd > 0) {
      startRoll("&{template:rolls} {{title=Dé d'Héroïsme}} {{text=@{character_name} obtient un bonus de [[d@{hd_val_dice}]].}}", (results) => {
        finishRoll(results.rollId);
      });
      setAttrs({
        hd: nhd-1
      });
    }
  });
});

on('clicked:repos', () => {
  console.log("repos");
  getAttrs(["hp_max", "hd_max"], (values) => {
    setAttrs({
      hp: parseInt(values.hp_max)||0,
      hd: parseInt(values.hd_max)||0
    });
  });
});
</script>

<!--
<main>

    



    <section class="header f-center">
      <h1>Example RPG</h1>
      <span>The Template Sheet</span>
    </section>
  
    <section class="common">
      <label>Char name: <input name="attr_character_name" type="text"></label>
      <label>Class: <input name="attr_class" list="class" type="text" ></label>
      <label>Race: <input name="attr_race" type="text" ></label>
      <label>HP: <input type="number" name="attr_hp" value="20"> / <input type="number" name="attr_hp_max" value="20"></label>
    </section>
  
    <section class="skill f-col nowrap">
      <h3>Attributes</h3>
      <div class="f-row nowrap">
        <label>Body</label>
        <input type="number" name="attr_body" value="3">
        <button type="roll" name="roll_body" value="&{template:rolls} {{title=Body}} {{subtitle=@{character_name} }} {{roll= [[d20+@{body}[body] ]]}}"> </button>
      </div>
      <div class="f-row nowrap">
        <label>Mind</label>
        <input type="number" name="attr_mind" value="3">
        <button type="roll" name="roll_mind" value="&{template:rolls} {{title=Mind}} {{subtitle=@{character_name} }} {{roll= [[d20+@{mind}[mind] ]]}}"> </button>
      </div>
      <div class="f-row nowrap">
        <label>Soul</label>
        <input type="number" name="attr_soul" value="3">
        <button type="roll" name="roll_soul" value="&{template:rolls} {{title=Soul}} {{subtitle=@{character_name} }} {{roll= [[d20+@{soul}[soul] ]]}}"> </button>
      </div>
  
      <h3>Skills</h3>
      <div class="f-col nowrap">
        <label>Initiative </label>
        <div class="f-row nowrap">
          <input type="number" name="attr_init" value="0">
          <button type="roll" name="roll_init" value="&{template:rolls} {{title=Initiative}} {{subtitle=@{character_name} }} {{roll= [[d20+(@{init}[init]) &{tracker}]]}}"> </button>
        </div>
      </div>
      <div class="f-col nowrap">
        <label>Stealth </label>
        <div class="f-row nowrap">
          <input type="number" name="attr_stealth" value="0">
          <button type="roll" name="roll_stealth" value="&{template:rolls} {{title=Stealth}} {{subtitle=@{character_name} }} {{roll= [[d20+(@{stealth}[stealth]) ]]}}"> </button>
        </div>
      </div>
      <div class="f-col nowrap">
        <label>Grapple </label>
        <div class="f-row nowrap">
          <input type="number" name="attr_grapple" value="0">
          <button type="roll" name="roll_grapple" value="&{template:rolls} {{title=Grapple}} {{subtitle=@{character_name} }} {{roll= [[d20+(@{body}[body])+(@{grapple}[grapple]) ]]}}"> </button>
        </div>
      </div>   
    </section>
  
    <section class="power f-col">
      <h3>Powers</h3>
      <fieldset class="repeating_power">
          <input name="attr_power" type="text" >
      </fieldset>
    </section>
  
    <section class="attack">
      <h3>Attacks</h3>
      <textarea name="attr_attacks"></textarea>
    </section>
  
    <section class="inv">
      <h3>Inventory</h3>
      <textarea name="attr_inventory"></textarea>
    </section>
  
    <section class="misc">
      <h3>Physical Description</h3>
      <textarea name="attr_description"></textarea>
    </section>
  
    <footer class="f-col f-center">
      <span>Generic copyright disclaimer</span>
    </footer>
  </main>
  -->
  <!-- Datalists & thing that don't show directly on sheet -->
  
  <!-- <datalist id="class">
      <option value="Fighter">Fighter</option>
      <option value="Mage">Mage</option>
      <option value="Expert">Expert</option>
  </datalist> -->
  
  <!-- roll template -->
  
  <!-- <rolltemplate class="sheet-rolltemplate-rolls">
    <div class="sheet-container">
      <div class="sheet-header" style="background-color: black;">
        {{#title}}<div class="sheet-title" style="text-align: center;">{{title}}</div>{{/title}}
        {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
        {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
      </div>
      <div class="sheet-content">
        {{#allprops() title name subtitle desc}}
        <div class="sheet-key">{{key}}</div>
        <div class="sheet-value">{{value}}</div>
        {{/allprops() title name subtitle desc}}
        {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
      </div>
    </div>
  </rolltemplate> -->

<rolltemplate class="sheet-rolltemplate-rolls">
  <div class="sheet-template-container">
    {{#title}}<div class="st-title">{{title}}</div>{{/title}}
    {{#text}}<div class="st-text">{{text}}</div>{{/text}}
  </div>
</rolltemplate>
